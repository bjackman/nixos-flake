#!/usr/bin/env bash
#
# Wrapper for 'falba compare with some ASI-benchmarking specific defaults.
#
# Usage:
#     compare-variants [--config-revision REV] [--instrumented] [--metric METRIC]
#     compare-variants --help
#
# Options:
#     -h --help              Show this screen.
#     --config-revision REV  NixOS configuration revision to compare variants
#                            of. This is a Git commit hash. If not specified,
#                            uses HEAD from CWD. Unlike if you were using falba
#                            directly, this doesn't need to be a full commit
#                            hash.
#     --instrumented         Compare instrumented runs instead of ignoring them.
#     --metric METRIC        Metric to compare [default: fio_randread_tmpfs_read_iops].

set -eu -o pipefail

source docopts.sh --auto -G "$@"

if [ -z "$ARGS_config_revision" ]; then
    if ! [ -z "$(git status --porcelain)" ]; then
        echo "Git tree is dirty, --config-revision must be specified"
        exit 1
    fi
    CONFIG_REVISION="$(git rev-parse HEAD)"
else
    CONFIG_REVISION="$(git rev-parse "$ARGS_config_revision")"
fi

falba compare \
    --fact-eq instrumented "$ARGS_instrumented" \
    --fact-eq nixos_configuration_revision "$CONFIG_REVISION" \
    os_release_variant_id "$ARGS_metric"