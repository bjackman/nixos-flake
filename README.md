# Flake for configuring NixOS systems

This flake defines some NixOS systems. To see what builds are available use `nix flake show .`.

There are some systems that have various kernel configurations available:

- `base` which is just a kinda minimal system but with somu specific setup for VM guests

- `aethelred` which is intended for a specific physical machine in my office.

## Ccache

NOTE: ccache is currently disabled (and deleted in `7932cc9`), because:

1. I was getting weird issues when using it with the basic kernel build Nix biz,
   Kbuild was complaining that it didn't support the assembler. I added some
   hackery to try and debug this but couldn't get any clarity. Maybe figuring
   out how to get an interactive shell in the build environment would be the
   way to figure this out.

2. I don't know how to enable it with the current `linuxPackages_custom` thing.
   I think this is something that's supported I just heave to learn a bit more
   about Nix and `callPackage`.

Before you do anything else you'll need to make ccache work with your Nix
installation. You can check this by doing:

```
nix run .#packages.x86_64-linux.hello
```

If it isn't setup that should  give you instructions.

## Run in a VM

You can run `base` in a VM like this:

```
nix run .#nixosConfigurations.base-nixos.config.system.build.vm
```
See the output of `nix flake show` for the other stuff that can be run.

### Debug the VM

The script that gets run to start the VM recognizes `QEMU_OPTS` so if you set
that to `QEMU_OPTS="-s -S"` you'll be able to attach GDB to it (`target remote
localhost:1234`).

GDB is not currently packaged into this repo I've just been using my ambient GDB
setup for this.

You can find the vmlinux with something like `nix eval
.#nixosConfigurations.aethelred-asi-modules-fix.config.system.build.kernel.dev
--raw`.

The Nix kernel build doesn't seem to include the GDB scripts from the kernel
tree but my workaround for that has just been to build them in a separate
checkout of the same kernel code (`make scripts_gdb`) and then run `source
<kernel-tree>/vmlinux-gdb.py` in the GDB prompt.

### Run with a kernel built outside of Nix

It can be tiresome to build the kernel with Nix every time for quick functional
debugging and testing. So you can build a kernel using the normal upstream
`make` stuffnd then point to the `bzImage` like so:

```sh
NIXPKGS_QEMU_KERNEL_nixos=$HOME/src/linux/linux/arch/x86/boot/bzImage
```

This will break the initrd's `modprobe` logic so you'll need to ensure you've
built in everything that's required to boot on this QEMU guest. You can achieve
that either by:

- Taking one of the configs checked in here under `kconfigs/` and doing `sed -i
  s/=m/=y/ .config` on it, or
- (Builds much faster) install
  [`virtme-ng`](https://github.com/arighi/virtme-ng), use its configuration, but
  add ext4 support:

  ```sh
  vng --kconfig && scripts/config -e EXT4_FS && make -j olddefconfig && make -sj100 bzImage
  ```

## Run on `aethelred`

I installed NixOS using the installer on `aethelred`. I can then rebuild it
according to the config in this Flake by running `nixos-rebuild` with the
`--target-host` option. It seems in principle like it should have been possible
to directly generate the disk image and just splat the build directly onto the
machine's disk without needing to run an installer at all.

You can install the configured system to `aethelred` (assuming it's at
`192.168.2.3` and your SSH key is already installed) using:

```sh
# Assuming you aren't on NixOS, to get `nixos-rebuild`:
nix develop .
 nixos-rebuild --flake .#aethelred-base --target-host brendan@$IP --use-remote-sudo switch
```

The configuration in use here is one that I created by starting from the default
NixOS config (which is enormous and takes ages to build) and incrementally
stripping it down, then adding back the stuff to make QEMU work again.

## Stuff I need to figure out

- Once I have some capability to actually read the damn code, try and stare at
  it and figure out how the hell the kernel build process works.
- Then, I also need `ccache` support. I asked about that
  [here](https://discourse.nixos.org/t/help-using-ccache-for-kernel-build/63010)
  but no answers yet.

  Someone at work suggested that `programs.ccache` might
  help, some of this will only work when building on NixOS but
  `programs.ccache.packageNames` might work in general. However, if I just threw
  that into `common.nix` nothing happened.

- I haven't figured out how to build disk images yet (although the QEMU VM built
  above does create a QCOW2 image). It seems like
  [`nixos-generators`](https://github.com/nix-community/nixos-generators) might
  be one answer. Alternatively I heard about `.config.system.build.sdImage`.
- I don't know how I'd have generated `aethelred-hardware-configuration.nix` -
  that was generated by the NixOS installer and then I copied it off the
  machine.
- I haven't really figured out how to make it easy to switch between kernel
  versions. Something that might help would be if the kernel source was a flake
  input instead of hard-coded into the NixOS module? Not sure, seems worth
  trying.