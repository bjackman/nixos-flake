# Flake for configuring NixOS systems

This flake defines some NixOS systems. To see what builds are available use `nix flake show .`.

There are some systems that have various kernel configurations available:

- `qemu` which is just a kinda minimal system but with somu specific setup for VM guests

- `aethelred` which is intended for a specific physical machine in my office.

Then there is `sandy` which is intended for a Raspberry Pi.

## Ccache

NOTE: ccache is currently disabled (and deleted in `7932cc9`), because:

1. I was getting weird issues when using it with the basic kernel build Nix biz,
   Kbuild was complaining that it didn't support the assembler. I added some
   hackery to try and debug this but couldn't get any clarity. Maybe figuring
   out how to get an interactive shell in the build environment would be the
   way to figure this out.

2. I don't know how to enable it with the current `linuxPackages_custom` thing.
   I think this is something that's supported I just heave to learn a bit more
   about Nix and `callPackage`.

Before you do anything else you'll need to make ccache work with your Nix
installation. You can check this by doing:

```
nix run .#packages.x86_64-linux.hello
```

If it isn't setup that should  give you instructions.

## Run in a VM

You can run `qemu` in a VM like this:

```
nix run .#nixosConfigurations.qemu-base.config.system.build.vm
```

The details of what this does seem to be configured by a set of options under
`virtualisation.*` (to access these I needed to import
`${modulesPath}/virtualisation/qemu-vm.nix`). For example, because I set
`virtualisation.forwardPorts`, you can SSH into the guest with `ssh -p 2222
localhost`.

See the output of `nix flake show` for the other stuff that can be run.

## Run on `aethelred`

I installed NixOS using the installer on `aethelred`. I can then rebuild it
according to the config in this Flake by running `nixos-rebuild` with the
`--target-host` option. It seems in principle like it should have been possible
to directly generate the disk image and just splat the build directly onto the
machine's disk without needing to run an installer at all.

You can install the configured system to `aethelred` (assuming it's at
`192.168.2.3` and your SSH key is already installed) using:

```sh
# Assuming you aren't on NixOS, to get `nixos-rebuild`:
nix develop .
 nixos-rebuild --flake .#aethelred-base --target-host brendan@$IP --use-remote-sudo switch
``` 

The configuration in use here is one that I created by starting from the default
NixOS config (which is enormous and takes ages to build) and incrementally
stripping it down, then adding back the stuff to make QEMU work again.

## Run on `sandy`

`sandy` is attached to a freebie ISP router (Virgin Media). I built the SD card image with:

```
nix build .#nixosConfigurations.sandy.config.system.build.sdImage
```

This took absolutely ages, I had to compile all of NixOS for aarch64. I haven't really made any attempt to avoid that, probably it's not that hard.

When I first installed it I was missing the `networking.hostName` setting and
this seemed to prevent DHCP from working, after that it worked OK.

## Stuff I need to figure out

- Once I have some capability to actually read the damn code, try and stare at
  it and figure out how the hell the kernel build process works.
- Then, I also need `ccache` support. I asked about that
  [here](https://discourse.nixos.org/t/help-using-ccache-for-kernel-build/63010)
  but no answers yet.

  Someone at work suggested that `programs.ccache` might
  help, some of this will only work when building on NixOS but
  `programs.ccache.packageNames` might work in general. However, if I just threw
  that into `common.nix` nothing happened.

- I haven't figured out how to build disk images yet (although the QEMU VM built
  above does create a QCOW2 image). It seems like
  [`nixos-generators`](https://github.com/nix-community/nixos-generators) might
  be one answer. Alternatively I heard about `.config.system.build.sdImage`.
- I don't know how I'd have generated `aethelred-hardware-configuration.nix` -
  that was generated by the NixOS installer and then I copied it off the
  machine.
- I haven't really figured out how to make it easy to switch between kernel
  versions. Something that might help would be if the kernel source was a flake
  input instead of hard-coded into the NixOS module? Not sure, seems worth
  trying.